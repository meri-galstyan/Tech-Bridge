<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Request Help – TechBridge</title>
  <link rel="stylesheet" href="help.css" />
  <link rel="icon" href="../images/logo_nobackground.png" type="image/png" />
</head>
<body>
  <h1>Request Help</h1>

  <button id="back">⬅️Go Back</button>
  <script>
    const backBtn = document.getElementById("back");
    if (backBtn) {
      backBtn.addEventListener("click", () => {
        window.history.back();
      });
    }
  </script>

  <form id="help-form">
    <label>Full Name:</label><br/>
    <input type="text" id="name" name="name" required /><br/><br/>

    <label>Phone Number:</label><br/>
    <input type="tel" id="phone" name="phone" required /><br/><br/>

    <label>Email (optional):</label><br/>
    <input type="email" id="email" name="email" /><br/><br/>

    <label>Preferred Contact Method:</label>
    <div class="radio-group">
      <input type="radio" name="contactMethod" value="Phone" checked /> Phone
      <input type="radio" name="contactMethod" value="Email" /> Email
      <input type="radio" name="contactMethod" value="Either" /> Either
    </div>

    <label>Tell us briefly what you need help with:</label><br/>
    <textarea id="description" name="description" required></textarea><br/><br/>

    <label>Urgency:</label><br/>
    <select id="urgency" required>
      <option value="">--Select one--</option>
      <option value="Not urgent">Not urgent</option>
      <option value="Sometime this week">Sometime this week</option>
      <option value="Within 2 days">Within 2 days</option>
      <option value="Urgent – today">Urgent – today</option>
    </select><br/><br/>

    <label>City:</label><br/>
    <input type="text" id="city" name="city" required /><br/><br/>

    <label>ZIP Code:</label><br/>
    <input
      type="text"
      id="zip"
      name="zip"
      required
      pattern="\d{5}"
      inputmode="numeric"
      maxlength="5"
    /><br/><br/>

    <button type="submit" style="font-size: 18px; padding: 10px 20px;">Request Help</button>
  </form>

  <script>
    const form = document.getElementById("help-form");
    const emailInput = document.getElementById("email");
    const zipInput = document.getElementById("zip");
    const contactRadios = document.querySelectorAll("input[name='contactMethod']");

    // Reset custom validity dynamically when contact method changes or email is typed
    const validateEmailField = () => {
      const contactMethod = document.querySelector("input[name='contactMethod']:checked").value;
      const email = emailInput.value.trim();

      if ((contactMethod === "Email" || contactMethod === "Either") && email === "") {
        emailInput.setCustomValidity("Please enter your email address or change the contact method.");
      } else {
        emailInput.setCustomValidity("");
      }
    };

    contactRadios.forEach(radio =>
      radio.addEventListener("change", validateEmailField)
    );
    emailInput.addEventListener("input", validateEmailField);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      validateEmailField(); // ensure we’re caught up before validation
      const isValid = form.reportValidity();
      if (!isValid) return;

      const payload = {
        name: document.getElementById("name").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        email: emailInput.value.trim(),
        contactMethod: document.querySelector("input[name='contactMethod']:checked").value,
        description: document.getElementById("description").value.trim(),
        urgency: document.getElementById("urgency").value,
        city: document.getElementById("city").value.trim(),
        zip: zipInput.value.trim()
      };

      try {
        const res = await fetch("http://localhost:5050/help-request", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (res.ok) {
          localStorage.setItem("lastHelpRequest", JSON.stringify(payload));
          window.location.href = "confirmation.html";
        } else {
          alert(`Failed: ${data.message}`);
        }
      } catch (err) {
        console.error(err);
        alert("Server error. Please try again later.");
      }
    });
  </script>
</body>
</html>
